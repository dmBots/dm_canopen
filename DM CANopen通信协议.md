**注意：目前 CANopen 只支持下面的这些命令，以及部分列举的字典参数，只适配了部分CiA402的字典控制，还有待完善**



## 1. 快速 SDO 命令

**SDO 写对象字典:**

|            |    数据1     |      数据2-3      |   数据4    |      数据5-8       |              |
| :--------: | :----------: | :---------------: | :--------: | :----------------: | :----------: |
| **客户端** | **CS命令符** | **索引(3为高位)** | **子索引** | **数据(高位在后)** | **>>服务器** |

**SDO 写对象响应:**

|              |    数据1     |      数据2-3      |   数据4    | 数据5-8 |            |
| :----------: | :----------: | :---------------: | :--------: | :-----: | :--------: |
| **客户端<<** | **CS命令符** | **索引(3为高位)** | **子索引** | **补0** | **服务器** |

**SDO 读对象字典:**

|            |    数据1     |      数据2-3      |   数据4    | 数据5-8 |              |
| :--------: | :----------: | :---------------: | :--------: | :-----: | :----------: |
| **客户端** | **CS命令符** | **索引(3为高位)** | **子索引** | **补0** | **>>服务器** |

**SDO 读对象响应:**

|              |    数据1     |      数据2-3      |   数据4    |      数据5-8       |            |
| :----------: | :----------: | :---------------: | :--------: | :----------------: | :--------: |
| **客户端<<** | **CS命令符** | **索引(3为高位)** | **子索引** | **数据(高位在后)** | **服务器** |

**CS 命令符：**

|   0x2F   |   写一个字节   |   0x40   |        读取        |
| :------: | :------------: | :------: | :----------------: |
| **0x2B** | **写两个字节** | **0x4F** | **读响应一个字节** |
| **0x27** | **写三个字节** | **0x4B** | **读响应两个字节** |
| **0x23** | **写四个字节** | **0x47** | **读响应三个字节** |
| **0x60** | **写成功应答** | **0x43** | **读响应四个字节** |
| **0x80** |  **异常响应**  |          |                    |

### 1.1 修改电机模式

|     命令     |    帧ID     | bit0 | bit1 | bit2 | bit3 |  bit4  | bit5 | bit6 | bit7 | 数据(bit7-bit4) |
| :----------: | :---------: | :--: | :--: | :--: | :--: | :----: | :--: | :--: | :--: | :-------------: |
|     使能     | 600+node_id |  2F  |  0B  |  20  |  02  | **01** |  00  |  00  |  00  |        1        |
|     失能     | 600+node_id |  2F  |  0B  |  20  |  02  | **02** |  00  |  00  |  00  |        2        |
|   设置模式   | 600+node_id |  2F  |  0B  |  20  |  02  | **03** |  00  |  00  |  00  |        3        |
|   扭矩模式   | 600+node_id |  2F  |  0B  |  20  |  01  | **01** |  00  |  00  |  00  |        1        |
|   速度模式   | 600+node_id |  2F  |  0B  |  20  |  01  | **03** |  00  |  00  |  00  |        3        |
| 位置速度模式 | 600+node_id |  2F  |  0B  |  20  |  01  | **02** |  00  |  00  |  00  |        2        |
|   清除错误   | 600+node_id |  2F  |  0B  |  20  |  03  | **01** |  00  |  00  |  00  |        1        |
|   保存零点   | 600+node_id |  2F  |  0B  |  20  |  04  | **01** |  00  |  00  |  00  |        1        |

### 1.2 修改和保存参数

只有电机在设置模式时，才能修改和保存参数

|     命令     |    帧ID     | bit0 | bit1 | bit2 | bit3 |  bit4  |  bit5  |  bit6  |  bit7  | 数据(bit7-bit4) | 映射范围 | 数据  |
| :----------: | :---------: | :--: | :--: | :--: | :--: | :----: | :----: | :----: | :----: | :-------------: | :------: | :---: |
|   保存参数   | 600+node_id |  23  |  10  |  10  |  01  |   00   |   00   |   00   |   00   |        0        |    -     |   -   |
| 修改心跳时间 | 600+node_id |  2B  |  17  |  10  |  00  | **00** | **00** |   00   |   00   |        0        |    -     |   -   |
| 修改node_id  | 600+node_id |  2F  |  03  |  20  |  01  | **02** |   00   |   00   |   00   |        2        |    -     |   -   |
|  修改波特率  | 600+node_id |  2B  |  03  |  20  |  02  | **E8** | **03** |   00   |   00   |      1000       |    -     |   -   |
| 修改电流带宽 | 600+node_id |  2B  |  04  |  20  |  03  | **E8** | **03** |   00   |   00   |      1000       |    -     |   -   |
|   修改过温   | 600+node_id |  2B  |  0A  |  20  |  01  | **FF** | **BF** |   00   |   00   |     0xBFFF      | -200-200 |  100  |
|  修改速度KP  | 600+node_id |  23  |  05  |  20  |  01  | **80** | **66** | **66** | **66** |   0x66666680    |   0-1    |  0.4  |
|  修改速度KI  | 600+node_id |  23  |  05  |  20  |  02  | **6F** | **12** | **83** | **00** |   0x0083126F    |   0-1    | 0.002 |
|  修改位置KP  | 600+node_id |  23  |  06  |  20  |  01  | **80** | **B8** | **1E** | **45** |   0x4CCCCD00    |  0-200   |  54   |
|  修改位置KI  | 600+node_id |  23  |  06  |  20  |  02  | **00** | **00** | **00** | **00** |   0x00000000    |  0-200   |   0   |
|   修改PMAX   | 600+node_id |  23  |  07  |  20  |  01  | **00** | **00** | **00** | **20** |   0x20000000    |  0-100   | 12.5  |
|   修改VMAX   | 600+node_id |  23  |  07  |  20  |  02  | **00** | **CD** | **CC** | **4C** |   0x4CCCCD00    |  0-100   |  30   |
|   修改TMAX   | 600+node_id |  23  |  07  |  20  |  03  | **A0** | **99** | **99** | **19** |   0x199999A0    |  0-100   |  10   |
|   修改过流   | 600+node_id |  2B  |  08  |  20  |  01  | **CC** | **CC** |   00   |   00   |   0x0000CCCC    |   0-1    |  0.8  |
|   修改限速   | 600+node_id |  23  |  80  |  60  |  00  | **40** | **33** | **33** | **33** |   0x33333340    |  0-3000  |  600  |
|  修改加速度  | 600+node_id |  23  |  83  |  60  |  00  | **50** | **B8** | **1E** | **05** |   0x051EB850    |  0-100   |   2   |
|  修改减速度  | 600+node_id |  23  |  84  |  60  |  00  | **00** | **48** | **E1** | **FA** |   0xFAE14800    |  -100-0  |  -2   |
|   修改过压   | 600+node_id |  2F  |  09  |  20  |  01  | **20** |   00   |   00   |   00   |      0x20       |    -     |   -   |
|   修改欠压   | 600+node_id |  2F  |  09  |  20  |  02  | **0F** |   00   |   00   |   00   |      0x0F       |    -     |   -   |

### 1.3 关闭TPDO

|   命令    |    帧ID     | bit0 | bit1 | bit2 | bit3 |  bit4  |  bit5  |  bit6  |  bit7  |  数据(bit7-bit4)   |
| :-------: | :---------: | :--: | :--: | :--: | :--: | :----: | :----: | :----: | :----: | :----------------: |
| 关闭TPDO1 | 600+node_id |  23  |  00  |  18  |  01  | **81** | **01** | **00** | **C0** | 0xC0000180+node_id |
| 关闭TPDO2 | 600+node_id |  23  |  01  |  18  |  01  | **81** | **02** | **00** | **C0** | 0xC0000280+node_id |
| 关闭TPDO3 | 600+node_id |  23  |  02  |  18  |  01  | **81** | **03** | **00** | **C0** | 0xC0000380+node_id |
| 关闭TPDO4 | 600+node_id |  23  |  03  |  18  |  01  | **81** | **04** | **00** | **C0** | 0xC0000480+node_id |

### 1.4 开启TPDO

|   命令    |    帧ID     | bit0 | bit1 | bit2 | bit3 |  bit4  |  bit5  |  bit6  |  bit7  | 数据(bit7-bit4) |
| :-------: | :---------: | :--: | :--: | :--: | :--: | :----: | :----: | :----: | :----: | :-------------: |
| 开启TPDO1 | 600+node_id |  23  |  00  |  18  |  01  | **81** | **01** | **00** | **00** |  0x180+node_id  |
| 开启TPDO2 | 600+node_id |  23  |  01  |  18  |  01  | **81** | **02** | **00** | **00** |  0x280+node_id  |
| 开启TPDO3 | 600+node_id |  23  |  02  |  18  |  01  | **81** | **03** | **00** | **00** |  0x380+node_id  |
| 开启TPDO4 | 600+node_id |  23  |  03  |  18  |  01  | **81** | **04** | **00** | **00** |  0x480+node_id  |

### 1.5 读参数

|   命令   |    帧ID     | bit0 | bit1 | bit2 | bit3 | bit4 | bit5 | bit6 | bit7 |
| :------: | :---------: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: |
| 保存参数 | 600+node_id |  40  |  10  |  10  |  01  |  00  |  00  |  00  |  00  |
| 心跳时间 | 600+node_id |  40  |  17  |  10  |  00  |  00  |  00  |  00  |  00  |
| node_id  | 600+node_id |  40  |  03  |  20  |  01  |  00  |  00  |  00  |  00  |
|  波特率  | 600+node_id |  40  |  03  |  20  |  02  |  00  |  00  |  00  |  00  |
| 电流带宽 | 600+node_id |  40  |  04  |  20  |  03  |  00  |  00  |  00  |  00  |
|   过温   | 600+node_id |  40  |  0A  |  20  |  01  |  00  |  00  |  00  |  00  |
|  速度KP  | 600+node_id |  40  |  05  |  20  |  01  |  00  |  00  |  00  |  00  |
|  速度KI  | 600+node_id |  40  |  05  |  20  |  02  |  00  |  00  |  00  |  00  |
|  位置KP  | 600+node_id |  40  |  06  |  20  |  01  |  00  |  00  |  00  |  00  |
|  位置KI  | 600+node_id |  40  |  06  |  20  |  02  |  00  |  00  |  00  |  00  |
|   PMAX   | 600+node_id |  40  |  07  |  20  |  01  |  00  |  00  |  00  |  00  |
|   VMAX   | 600+node_id |  40  |  07  |  20  |  02  |  00  |  00  |  00  |  00  |
|   TMAX   | 600+node_id |  40  |  07  |  20  |  03  |  00  |  00  |  00  |  00  |
|   过流   | 600+node_id |  40  |  08  |  20  |  01  |  00  |  00  |  00  |  00  |
|   限速   | 600+node_id |  40  |  80  |  60  |  00  |  00  |  00  |  00  |  00  |
|  加速度  | 600+node_id |  40  |  83  |  60  |  00  |  00  |  00  |  00  |  00  |
|  减速度  | 600+node_id |  40  |  84  |  60  |  00  |  00  |  00  |  00  |  00  |
|   过压   | 600+node_id |  40  |  09  |  20  |  01  |  00  |  00  |  00  |  00  |
|   欠压   | 600+node_id |  40  |  09  |  20  |  02  |  00  |  00  |  00  |  00  |

## 2. RPDO 命令

RPDO 的映射数据可以通过SDO写命令写入RPDO映射寄存器来修改RPDO映射接收的数据

### 2.1 RPDO1 命令格式

|  ID   |   COB ID    | byte0-byte1 | byte2 |
| :---: | :---------: | :---------: | :---: |
| RPDO1 | 200+node_id |   控制字    | 模式  |

### 2.2 RPDO2 命令格式

|  ID   |   COB ID    | byte0-byte3 | byte4-byte7 |
| :---: | :---------: | :---------: | :---------: |
| RPDO2 | 300+node_id |  目标速度   |  目标位置   |

### 2.3 RPDO3 命令格式

为了减少PDO的通信负担，可以使用这一条通信格式来接收命令帧

|  ID   |   COB ID    | byte0-byte3 |
| :---: | :---------: | :---------: |
| RPDO3 | 400+node_id |  Fast RPDO  |

命令格式：

| sref_int | pref_int | vref_int | tref_int |
| :------: | :------: | :------: | :------: |
|   模式   | 目标位置 | 目标速度 | 目标扭矩 |

相应的代码格式转换

```c
uint16_t s_refint = (uint16_t)(OD_RAM.x200D_fastRPDO >> 48);
uint16_t p_refint = (uint16_t)(OD_RAM.x200D_fastRPDO >> 32);
uint16_t v_refint = (uint16_t)(OD_RAM.x200D_fastRPDO >> 16);
uint16_t t_refint = (uint16_t)(OD_RAM.x200D_fastRPDO >> 0 );
	
uint8_t mode = s_refint&0xFF;

float pref = uint_to_float(p_refint,  -TMP.PMAX, TMP.PMAX,16);
float vref = uint_to_float(v_refint,  -TMP.VMAX, TMP.VMAX,16);
float tref = uint_to_float(t_refint,  -TMP.TMAX, TMP.TMAX,16);
```

## 3. TPDO 命令

### 3.1 TPDO1 命令格式

|  ID   |   COB ID    | byte0-byte1 | byte2-byte3 |
| :---: | :---------: | :---------: | :---------: |
| TPDO1 | 200+node_id |   状态字    |  实际扭矩   |

### 3.2 TPDO2 命令格式

|  ID   |   COB ID    | byte0-byte1 | byte2-byte3 |
| :---: | :---------: | :---------: | :---------: |
| TPDO2 | 300+node_id |  实际速度   |  实际位置   |

### 3.3 TPDO3 命令格式

为了减少PDO的通信负担，可以使用这一条通信格式来接收命令帧

|  ID   |   COB ID    | byte0-byte3 |
| :---: | :---------: | :---------: |
| TPDO3 | 400+node_id |  Fast TPDO  |

命令格式：

|          sref_int           |  p_int   |  v_int   |  t_int   |
| :-------------------------: | :------: | :------: | :------: |
| state<<12\|mode<<8\|node_id | 实际位置 | 实际速度 | 实际扭矩 |

相应的代码格式转换

```c
OD_RAM.x6064_positionActualValue= float_to_uint(MTR.p_m, -TMP.PMAX, TMP.PMAX,16);
OD_RAM.x606C_velocityActualValue= float_to_uint(MTR.v_m, -TMP.VMAX, TMP.VMAX,16);
OD_RAM.x6077_torqueActualValue 	= float_to_uint(MTR.Te,  -TMP.TMAX, TMP.TMAX,16);    
OD_RAM.x6041_statusword 		= (ctrler.ERR_STATE<<12)|(TMP.cmode<<8)|(TMP.ESC_ID);
	
uint16_t s_int = OD_RAM.x6041_statusword;
uint16_t p_int = OD_RAM.x6064_positionActualValue;
uint16_t v_int = OD_RAM.x606C_velocityActualValue;
uint16_t t_int = OD_RAM.x6077_torqueActualValue;

OD_RAM.x200C_fastTPDO = ((uint64_t)s_int << 48) |
						((uint64_t)p_int << 32) |
						((uint64_t)v_int << 16) |
						((uint64_t)t_int << 0 );
```

